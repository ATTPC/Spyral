
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the Spyral AT-TPC analysis framework">
      
      
      
        <link rel="canonical" href="https://example.com/api/core/clusterize/">
      
      
        <link rel="prev" href="../cluster/">
      
      
        <link rel="next" href="../config/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.14">
    
    
      
        <title>clusterize - Spyral</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.fad675c6.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="green">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#clusterize-module" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Spyral" class="md-header__button md-logo" aria-label="Spyral" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Spyral
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              clusterize
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="green"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/turinath/Spyral/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Spyral" class="md-nav__button md-logo" aria-label="Spyral" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Spyral
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/turinath/Spyral/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../quick_start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick Start
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/getting_started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Configuration
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Configuration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/config/about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About Configurations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/config/workspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Workspace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/config/run/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Run
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/config/detector/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Detector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/config/traces/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GET & FRIB Traces
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/config/cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cluster
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/config/estimate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Estimate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/config/solver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Solver
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/config/extending/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extending the Config
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Analysis Phases
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Analysis Phases
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/phases/about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About Phases
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/phases/point_cloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Point Cloud
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/phases/cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cluster
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/phases/estimate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Estimate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/phases/solve/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Solve
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/numba/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Numba
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/parallel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Parallel Processing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/notebooks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Notebooks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/continuing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    After Spyral
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Spyral Reference
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../run_parallel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    run_parallel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../run/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    run
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../phase_pointcloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    phase_pointcloud
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../phase_cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    phase_cluster
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../phase_estimate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    phase_estimate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../phase_solve/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    phase_solve
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_8" checked>
        
          
          <label class="md-nav__link" for="__nav_4_8" id="__nav_4_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    core
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_8">
            <span class="md-nav__icon md-icon"></span>
            core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About core
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cluster
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    clusterize
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    clusterize
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#spyral.core.clusterize" class="md-nav__link">
    <span class="md-ellipsis">
      clusterize
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spyral.core.clusterize.cleanup_clusters" class="md-nav__link">
    <span class="md-ellipsis">
      cleanup_clusters()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spyral.core.clusterize.form_clusters" class="md-nav__link">
    <span class="md-ellipsis">
      form_clusters()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spyral.core.clusterize.join_clusters" class="md-nav__link">
    <span class="md-ellipsis">
      join_clusters()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spyral.core.clusterize.join_clusters_step" class="md-nav__link">
    <span class="md-ellipsis">
      join_clusters_step()
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../constants/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    constants
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../estimator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    estimator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware_id/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hardware_id
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pad_map/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pad_map
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../point_cloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    point_cloud
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../spy_log/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    spy_log
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../track_generator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    track_generator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    workspace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../legacy_beam_pads/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    legacy_beam_pads
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_9" >
        
          
          <label class="md-nav__link" for="__nav_4_9" id="__nav_4_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    correction
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_9">
            <span class="md-nav__icon md-icon"></span>
            correction
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../correction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About correction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../correction/generate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    generate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../correction/electron_corrector/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    electron_corrector
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10" >
        
          
          <label class="md-nav__link" for="__nav_4_10" id="__nav_4_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    geometry
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10">
            <span class="md-nav__icon md-icon"></span>
            geometry
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../geometry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About geometry
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../geometry/circle/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    circle
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_11" >
        
          
          <label class="md-nav__link" for="__nav_4_11" id="__nav_4_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    interpolate
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_11">
            <span class="md-nav__icon md-icon"></span>
            interpolate
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../interpolate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About interpolate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../interpolate/bilinear/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bilinear
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../interpolate/linear/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    linear
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../interpolate/track_interpolator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    track_interpolator
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_12" >
        
          
          <label class="md-nav__link" for="__nav_4_12" id="__nav_4_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    parallel
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_12">
            <span class="md-nav__icon md-icon"></span>
            parallel
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../parallel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About parallel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../parallel/run_stack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    run_stack
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../parallel/status_message/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    status_message
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_13" >
        
          
          <label class="md-nav__link" for="__nav_4_13" id="__nav_4_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    solvers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_13">
            <span class="md-nav__icon md-icon"></span>
            solvers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../solvers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About solvers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../solvers/guess/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    guess
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../solvers/solver_interp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    solver_interp
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_14" >
        
          
          <label class="md-nav__link" for="__nav_4_14" id="__nav_4_14_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    trace
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_14">
            <span class="md-nav__icon md-icon"></span>
            trace
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../trace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About trace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../trace/get_event/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    get_event
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../trace/get_legacy_event/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    get_legacy_event
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../trace/get_trace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    get_trace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../trace/frib_event/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    frib_event
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../trace/frib_trace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    frib_trace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../trace/peak/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    peak
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../faq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FAQ
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../for_devs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    For Developers
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#spyral.core.clusterize" class="md-nav__link">
    <span class="md-ellipsis">
      clusterize
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spyral.core.clusterize.cleanup_clusters" class="md-nav__link">
    <span class="md-ellipsis">
      cleanup_clusters()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spyral.core.clusterize.form_clusters" class="md-nav__link">
    <span class="md-ellipsis">
      form_clusters()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spyral.core.clusterize.join_clusters" class="md-nav__link">
    <span class="md-ellipsis">
      join_clusters()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spyral.core.clusterize.join_clusters_step" class="md-nav__link">
    <span class="md-ellipsis">
      join_clusters_step()
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="clusterize-module">clusterize Module</h1>
<p>The clusterize module describes the methods used to convert a raw point cloud into a trajectory cluster.</p>


<div class="doc doc-object doc-module">



<a id="spyral.core.clusterize"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h2 id="spyral.core.clusterize.cleanup_clusters" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">cleanup_clusters</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Converts the LabeledClouds to Clusters and bins the data in z</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>clusters</code></td>
          <td>
                <code>list[<a class="autorefs autorefs-internal" title="spyral.core.cluster.LabeledCloud" href="../cluster/#spyral.core.cluster.LabeledCloud">LabeledCloud</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>clusters to clean</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="spyral.core.config.ClusterParameters" href="../config/#spyral.core.config.ClusterParameters">ClusterParameters</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Configuration parameters controlling the clustering algorithms</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>list[<a class="autorefs autorefs-internal" title="spyral.core.cluster.Cluster" href="../cluster/#spyral.core.cluster.Cluster">Cluster</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The cleaned clusters</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>spyral/core/clusterize.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">cleanup_clusters</span><span class="p">(</span>
    <span class="n">clusters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">LabeledCloud</span><span class="p">],</span> <span class="n">params</span><span class="p">:</span> <span class="n">ClusterParameters</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Cluster</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts the LabeledClouds to Clusters and bins the data in z</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    clusters: list[LabeledCloud]</span>
<span class="sd">        clusters to clean</span>
<span class="sd">    params: ClusterParameters</span>
<span class="sd">        Configuration parameters controlling the clustering algorithms</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[Cluster]</span>
<span class="sd">        The cleaned clusters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Cluster must have more than two points to have outlier test applied</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">convert_labeled_to_cluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span>
        <span class="k">if</span> <span class="n">cluster</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">cloud</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="spyral.core.clusterize.form_clusters" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">form_clusters</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Apply the HDBSCAN clustering algorithm to a PointCloud</p>
<p>Analyze a point cloud, and group the points into clusters which in principle should correspond to particle trajectories. This analysis contains several steps,
and revolves around the HDBSCAN clustering algorithm implemented in scikit-learn (see <a href="https://scikit-learn.org/stable/modules/generated/sklearn.cluster.HDBSCAN.html">their description</a> for details)
First the point cloud is smoothed by averaging over nearest neighbors (defined by the smoothing_neighbor_distance parameter) to remove small deviations.
The data is then scaled where each coordinate (x,y,z,int) is centered to its mean and then scaled to its std deviation using the scikit-learn StandardScaler. This data is then
clustered by HDBSCAN and the clusters are returned.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>pc</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="spyral.core.point_cloud.PointCloud" href="../point_cloud/#spyral.core.point_cloud.PointCloud">PointCloud</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The point cloud to be clustered</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="spyral.core.config.ClusterParameters" href="../config/#spyral.core.config.ClusterParameters">ClusterParameters</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Configuration parameters controlling the clustering algorithms</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>list[<a class="autorefs autorefs-internal" title="spyral.core.cluster.LabeledCloud" href="../cluster/#spyral.core.cluster.LabeledCloud">LabeledCloud</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>List of clusters found by the algorithm with labels</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>spyral/core/clusterize.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">form_clusters</span><span class="p">(</span><span class="n">pc</span><span class="p">:</span> <span class="n">PointCloud</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">ClusterParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">LabeledCloud</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply the HDBSCAN clustering algorithm to a PointCloud</span>

<span class="sd">    Analyze a point cloud, and group the points into clusters which in principle should correspond to particle trajectories. This analysis contains several steps,</span>
<span class="sd">    and revolves around the HDBSCAN clustering algorithm implemented in scikit-learn (see [their description](https://scikit-learn.org/stable/modules/generated/sklearn.cluster.HDBSCAN.html) for details)</span>
<span class="sd">    First the point cloud is smoothed by averaging over nearest neighbors (defined by the smoothing_neighbor_distance parameter) to remove small deviations.</span>
<span class="sd">    The data is then scaled where each coordinate (x,y,z,int) is centered to its mean and then scaled to its std deviation using the scikit-learn StandardScaler. This data is then</span>
<span class="sd">    clustered by HDBSCAN and the clusters are returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pc: PointCloud</span>
<span class="sd">        The point cloud to be clustered</span>
<span class="sd">    params: ClusterParameters</span>
<span class="sd">        Configuration parameters controlling the clustering algorithms</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    list[LabeledCloud]</span>
<span class="sd">        List of clusters found by the algorithm with labels</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Smooth out the point cloud by averaging over neighboring points within a distance, droping any duplicate points</span>
    <span class="n">pc</span><span class="o">.</span><span class="n">smooth_cloud</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">smoothing_neighbor_distance</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pc</span><span class="o">.</span><span class="n">cloud</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">min_cloud_size</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">n_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pc</span><span class="o">.</span><span class="n">cloud</span><span class="p">)</span>
    <span class="n">min_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">min_size_scale_factor</span> <span class="o">*</span> <span class="n">n_points</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">min_size</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">min_size_lower_cutoff</span><span class="p">:</span>
        <span class="n">min_size</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">min_size_lower_cutoff</span>

    <span class="c1"># Use spatial dimensions and integrated charge</span>
    <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pc</span><span class="o">.</span><span class="n">cloud</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">cluster_data</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">pc</span><span class="o">.</span><span class="n">cloud</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span>

    <span class="c1"># Unfiy feature ranges to their means and have standard variance (1)</span>
    <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">)</span>

    <span class="n">clusterizer</span> <span class="o">=</span> <span class="n">skcluster</span><span class="o">.</span><span class="n">HDBSCAN</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="n">min_cluster_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span>
        <span class="n">min_samples</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">min_points</span><span class="p">,</span>
        <span class="n">allow_single_cluster</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cluster_selection_epsilon</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">cluster_selection_epsilon</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">fitted_clusters</span> <span class="o">=</span> <span class="n">clusterizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">fitted_clusters</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>

    <span class="c1"># Select out data into clusters</span>
    <span class="n">clusters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">LabeledCloud</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LabeledCloud</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">PointCloud</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">fitted_clusters</span><span class="o">.</span><span class="n">labels_</span> <span class="o">==</span> <span class="n">label</span>
        <span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">cloud</span> <span class="o">=</span> <span class="n">pc</span><span class="o">.</span><span class="n">cloud</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">event_number</span> <span class="o">=</span> <span class="n">pc</span><span class="o">.</span><span class="n">event_number</span>
        <span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">clustered_data</span> <span class="o">=</span> <span class="n">cluster_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">clusters</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="spyral.core.clusterize.join_clusters" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">join_clusters</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Join clusters until either only one cluster is left or no clusters meet the criteria to be joined together.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>clusters</code></td>
          <td>
                <code>list[<a class="autorefs autorefs-internal" title="spyral.core.cluster.LabeledCloud" href="../cluster/#spyral.core.cluster.LabeledCloud">LabeledCloud</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the set of clusters to examine</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="spyral.core.config.ClusterParameters" href="../config/#spyral.core.config.ClusterParameters">ClusterParameters</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>contains parameters controlling the joining algorithm</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>list[<a class="autorefs autorefs-internal" title="spyral.core.cluster.LabeledCloud" href="../cluster/#spyral.core.cluster.LabeledCloud">LabeledCloud</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the set of joined clusters</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>spyral/core/clusterize.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">join_clusters</span><span class="p">(</span>
    <span class="n">clusters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">LabeledCloud</span><span class="p">],</span> <span class="n">params</span><span class="p">:</span> <span class="n">ClusterParameters</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">LabeledCloud</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Join clusters until either only one cluster is left or no clusters meet the criteria to be joined together.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    clusters: list[LabeledCloud]</span>
<span class="sd">        the set of clusters to examine</span>
<span class="sd">    params: ClusterParameters</span>
<span class="sd">        contains parameters controlling the joining algorithm</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[LabeledCloud]</span>
<span class="sd">        the set of joined clusters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jclusters</span> <span class="o">=</span> <span class="n">clusters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jclusters</span><span class="p">)</span>
    <span class="n">after</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">before</span> <span class="o">!=</span> <span class="n">after</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">jclusters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jclusters</span><span class="p">)</span>
        <span class="n">jclusters</span> <span class="o">=</span> <span class="n">join_clusters_step</span><span class="p">(</span><span class="n">jclusters</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jclusters</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jclusters</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h2 id="spyral.core.clusterize.join_clusters_step" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">join_clusters_step</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>A single step of joining clusters</p>
<p>Combine clusters based on the center around which they orbit. This is necessary because often times tracks are
fractured or contain regions of varying density which causes clustering algorithms to separate them.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>clusters</code></td>
          <td>
                <code>list[<a class="autorefs autorefs-internal" title="spyral.core.cluster.LabeledCloud" href="../cluster/#spyral.core.cluster.LabeledCloud">LabeledCloud</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the set of clusters to examine</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="spyral.core.config.ClusterParameters" href="../config/#spyral.core.config.ClusterParameters">ClusterParameters</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>contains the parameters controlling the joining algorithm (max_center_distance)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>list[<a class="autorefs autorefs-internal" title="spyral.core.cluster.LabeledCloud" href="../cluster/#spyral.core.cluster.LabeledCloud">LabeledCloud</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the set of joined clusters</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>spyral/core/clusterize.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">join_clusters_step</span><span class="p">(</span>
    <span class="n">clusters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">LabeledCloud</span><span class="p">],</span> <span class="n">params</span><span class="p">:</span> <span class="n">ClusterParameters</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">LabeledCloud</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single step of joining clusters</span>

<span class="sd">    Combine clusters based on the center around which they orbit. This is necessary because often times tracks are</span>
<span class="sd">    fractured or contain regions of varying density which causes clustering algorithms to separate them.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    clusters: list[LabeledCloud]</span>
<span class="sd">        the set of clusters to examine</span>
<span class="sd">    params: ClusterParameters</span>
<span class="sd">        contains the parameters controlling the joining algorithm (max_center_distance)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[LabeledCloud]</span>
<span class="sd">        the set of joined clusters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Can&#39;t join 1 or 0 clusters</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">clusters</span>

    <span class="n">event_number</span> <span class="o">=</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">event_number</span>

    <span class="c1"># Fit the clusters with circles</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>
        <span class="n">centers</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">centers</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">centers</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">least_squares_circle</span><span class="p">(</span>
            <span class="n">cluster</span><span class="o">.</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">cloud</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cluster</span><span class="o">.</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">cloud</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="c1"># Make a dictionary of center groups</span>
    <span class="c1"># First everyone is in their own group</span>
    <span class="n">groups</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>
        <span class="n">groups</span><span class="p">[</span><span class="n">cluster</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="c1"># Now regroup, searching for clusters whose circles mostly overlap</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">center</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">centers</span><span class="p">):</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="c1"># Reject noise</span>
        <span class="k">if</span> <span class="n">cluster</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">10.0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">radius</span><span class="o">**</span><span class="mf">2.0</span>

        <span class="k">for</span> <span class="n">cidx</span><span class="p">,</span> <span class="n">comp_cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusters</span><span class="p">):</span>
            <span class="n">comp_center</span> <span class="o">=</span> <span class="n">centers</span><span class="p">[</span><span class="n">cidx</span><span class="p">]</span>
            <span class="n">comp_radius</span> <span class="o">=</span> <span class="n">comp_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">comp_area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">comp_radius</span><span class="o">**</span><span class="mf">2.0</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">comp_cluster</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">comp_center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="ow">or</span> <span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">10.0</span>
                <span class="ow">or</span> <span class="n">cidx</span> <span class="o">==</span> <span class="n">idx</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Calculate area of overlap between the two circles</span>
            <span class="c1"># See Wolfram MathWorld https://mathworld.wolfram.com/Circle-CircleIntersection.html</span>
            <span class="n">center_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">comp_center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mf">2.0</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">comp_center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mf">2.0</span>
            <span class="p">)</span>
            <span class="n">term1</span> <span class="o">=</span> <span class="p">(</span><span class="n">center_distance</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">radius</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">comp_radius</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="mf">2.0</span> <span class="o">*</span> <span class="n">center_distance</span> <span class="o">*</span> <span class="n">radius</span>
            <span class="p">)</span>
            <span class="n">term2</span> <span class="o">=</span> <span class="p">(</span><span class="n">center_distance</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">comp_radius</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">radius</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="mf">2.0</span> <span class="o">*</span> <span class="n">center_distance</span> <span class="o">*</span> <span class="n">comp_radius</span>
            <span class="p">)</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="o">-</span><span class="n">center_distance</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="n">comp_radius</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">center_distance</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">-</span> <span class="n">comp_radius</span>
            <span class="n">c3</span> <span class="o">=</span> <span class="n">center_distance</span> <span class="o">-</span> <span class="n">radius</span> <span class="o">+</span> <span class="n">comp_radius</span>
            <span class="n">c4</span> <span class="o">=</span> <span class="n">center_distance</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="n">comp_radius</span>
            <span class="n">term3</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">c3</span> <span class="o">*</span> <span class="n">c4</span>
            <span class="n">area_overlap</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="c1"># term3 cant be negative, inside sqrt.</span>
            <span class="k">if</span> <span class="n">term3</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">c1</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="c1"># Cannot possibly overlap, too far apart</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">term3</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">c2</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">c3</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="c1"># Entirely overlap one circle inside of the other</span>
                <span class="n">area_overlap</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">comp_area</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Circles only somewhat overlap</span>
                <span class="n">term1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">term1</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># clamp to arccos range to avoid silly floating point precision errors</span>
                <span class="n">term2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">term2</span><span class="p">))</span>
                <span class="n">area_overlap</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">radius</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">term1</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">comp_radius</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">term2</span><span class="p">)</span>
                    <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">term3</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">smaller_area</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">comp_area</span><span class="p">)</span>
            <span class="n">comp_mean_charge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">comp_cluster</span><span class="o">.</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">cloud</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">mean_charge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">cloud</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">charge_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mean_charge</span> <span class="o">-</span> <span class="n">comp_mean_charge</span><span class="p">)</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fractional_charge_threshold</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                <span class="p">[</span><span class="n">comp_mean_charge</span><span class="p">,</span> <span class="n">mean_charge</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">area_overlap</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">circle_overlap_ratio</span> <span class="o">*</span> <span class="n">smaller_area</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">cidx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">[</span><span class="n">cluster</span><span class="o">.</span><span class="n">label</span><span class="p">])</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">charge_diff</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">comp_group</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">comp_cluster</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">subs</span> <span class="ow">in</span> <span class="n">comp_group</span><span class="p">:</span>
                    <span class="n">clusters</span><span class="p">[</span><span class="n">subs</span><span class="p">]</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">label</span>
                <span class="n">groups</span><span class="p">[</span><span class="n">cluster</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">comp_group</span><span class="p">)</span>

    <span class="c1"># Now reform the clouds such that there is one cloud per group</span>
    <span class="n">new_clusters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">LabeledCloud</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">g</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">new_cluster</span> <span class="o">=</span> <span class="n">LabeledCloud</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">PointCloud</span><span class="p">())</span>
        <span class="n">new_cluster</span><span class="o">.</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">event_number</span> <span class="o">=</span> <span class="n">event_number</span>
        <span class="n">new_cluster</span><span class="o">.</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">cloud</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
            <span class="n">new_cluster</span><span class="o">.</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">cloud</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span><span class="n">new_cluster</span><span class="o">.</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">cloud</span><span class="p">,</span> <span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">point_cloud</span><span class="o">.</span><span class="n">cloud</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
        <span class="n">new_clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_cluster</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_clusters</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.cd18aaf1.min.js"></script>
      
        <script src="../../../javascript/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>